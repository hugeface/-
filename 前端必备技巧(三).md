# 前端必备技巧(三)

### 渲染机制

- 什么是DOCTYPE及作用

    DTD(文档类型定义):一系列语法规则，定义XML或(X)HTML的文件类型。浏览器会使用它来判断文档类型，决定使用何种协议来解析，以及切换浏览器模式。 
    
    DOCTYPE：用来声明文档类型和DTD规范，一个主要的用途便是文件的合法性验证。如果文件代码不合法，那么浏览器解析时便会出一些差错。告诉浏览器当前文档包含的是哪个DTD，也就是文档类型。
    
    常见的DOCTYPE：
    - HTML 5	 <!DOCTYPE html>
    - HTML 4 Strict  
        HTML 4 严格模式，该DTD包含所有HTML元素和属性，但不包括展示性和废弃的元素（如font）
    - HTML 4 Transitional    
        HTML 4 传统模式，该DTD包含所有HTML元素和属性，包括展示性和废弃的元素

- 浏览器渲染过程
    
    ![浏览器渲染过程](./imgs/浏览器渲染过程.png)
    
    1. 当用户输入一个URL，浏览器就会发送一个请求，请求URL对应的资源
    2. HTML解析器会将这个文件解析，构建成一棵DOM树
    3. 构建DOM树时，遇到JS和CSS元素，HTML解析器就将控制权转让给JS或者CSS解析器
    4. JS或者CSS解析器解析完这个元素时候，HTML又继续解析下个元素，直到整棵DOM树构建完成
    5. DOM树构建完之后，浏览器把DOM树中的一些不可视元素去掉，然后与CSSOM合成一棵render树
    6. 接着浏览器根据这棵render树，计算出各个节点(元素)在屏幕的位置。这个过程叫做layout，输出的是一棵layout树
    7. 最后浏览器根据这棵layout树，将页面渲染到屏幕上去

- 重排(Reflow)

    - 定义： DOM结构中的各个元素都有自己的盒子（模型），这些都需要浏览器根据各种样式计算结果将元素放到它该出现的位置，这个过程称之为Reflow
    - 触发条件
        1. 增加、删除、修改DOM节点
        2. 移动DOM的位置，或是制作动画效果
        3. 修改CSS样式
        4. Resize窗口，或是滚动屏幕
        5. 修改网页的默认字体（不推荐，影响性能）

- 重绘(Repaint)

    - 定义：当各种盒子的位置、大小以及其他属性，例如颜色、字体大小等都确定下来后，浏览器把这些元素按照各自的特性绘制一遍，使页面内容出现，这个过程称为Repaint，应尽量减少重绘
    - 触发条件：改动DOM、改动CSS

- 布局(Layout)

### JS运行机制

![js事件队列](./imgs/EventLoop.png)

JS是单线程的，同一时间只能干一件事。    
任务队列：同步任务，异步任务。setTimeout是异步任务，异步任务要挂起；同步任务执行完才回去执行异步任务
```JavaScript
console.log(1);
setTimeout(function () {
    console.log(2);
}, 0);      // 实际上，现代浏览器中最小延迟单位为4ms
console.log(3);
console.log(4);     // 输出：1 3 4 2
```

异步事件：1、setTimeout和setInterval；2、DOM事件；3、ES6中的Promise
